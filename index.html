<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Allergy Test</title>
  <style>
    :root{
      --bg1:#f6fbff;
      --bg2:#e8f6ff;
      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.92);
      --stroke: rgba(10,30,60,.10);
      --stroke2: rgba(10,30,60,.14);
      --text: rgba(8,20,40,.92);
      --blue: #22c3ff;
      --blue2:#6aa8ff;
      --hot: #ff2d2d;
      --p: 0;
      --shadow: 0 18px 55px rgba(10,30,60,.12);
      --shadow2: 0 14px 40px rgba(10,30,60,.10);
    }

    *{box-sizing:border-box}

    html,body{
      height:100%;
      margin:0;
      overflow:hidden;
      -webkit-text-size-adjust: 100%;
    }

    body{
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      color:var(--text);
      background: linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height: 100dvh;
    }

    .app{
      min-height: 100dvh;
      height: 100%;
      display:flex;
      flex-direction:column;
      padding: calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom));
      max-width: 500px;
      margin: 0 auto;
      position: relative;
    }

    header{ text-align: center; padding: 10px 0; }
    .title{
      display: inline-block;
      font-weight: 900;
      font-size: 28px;
      padding: 12px 24px;
      border-radius: 20px;
      background: white;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }

    .panel{
      background: var(--card2);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 16px;
      margin-top: 20px;
      transition: all 0.4s ease;
    }
    .panel.hide { opacity: 0; transform: translateY(-20px); pointer-events: none; }

    #nameInput{
      width:100%;
      height:50px;
      border-radius: 12px;
      border: 1px solid var(--stroke2);
      padding: 0 15px;
      font-size: 16px;
      margin-bottom: 12px;
    }

    /* Age scroller */
    .ageTrack{
      display:flex;
      overflow-x:auto;
      gap:10px;
      padding: 10px calc(50% - 26px);
      scroll-snap-type: x mandatory;
      scroll-snap-stop: always;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-x: contain;
      user-select: none;
      -webkit-user-select: none;
      touch-action: pan-x;
    }
    .ageTrack::-webkit-scrollbar{ display:none; }

    .ageItem{
      min-width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      scroll-snap-align: center;
      font-weight: 800;
      flex: 0 0 auto;
      transition: transform 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, color 0.18s ease;
      box-shadow: 0 10px 22px rgba(10,30,60,.06);
    }
    .ageItem.selected{
      background: rgba(34,195,255,.12);
      border-color: rgba(34,195,255,.55);
      box-shadow: 0 14px 28px rgba(34,195,255,.18);
      transform: scale(1.10);
      color: rgba(8,20,40,.95);
      position: relative;
    }
    .ageItem.selected::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 16px;
      border: 2px solid var(--blue);
      pointer-events:none;
    }

    .scannerArea{
      flex:1;
      position:relative;
      display:flex;
      align-items: center;
      justify-content: center;
      min-height: 320px;
    }

    .arc{
      position:absolute;
      width: 100%;
      height: 260px;
      top: 0;
      left: 0;
      pointer-events:none;
    }

    .bubble{
      position:absolute;
      width: 70px;
      height: 70px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      transform: translate(-50%, -50%);
      z-index: 10;

      --moveDur: 1.2s;
      --moveEase: cubic-bezier(0.4, 0, 0.2, 1);
      transition:
        left var(--moveDur) var(--moveEase),
        top var(--moveDur) var(--moveEase),
        width var(--moveDur) var(--moveEase),
        height var(--moveDur) var(--moveEase),
        font-size var(--moveDur) var(--moveEase),
        border 0.75s ease,
        box-shadow 0.75s ease,
        opacity 0.4s ease;
      will-change: left, top, width, height, font-size, transform;
    }

    .bubble.center-move{
      --moveDur: 1.9s;
      --moveEase: cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    .bubble.replace { animation: pulseIcon 0.4s ease; }
    @keyframes pulseIcon {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(0.6); opacity: 0.5; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .bubble.result-active {
      border: 4px solid var(--hot);
      box-shadow: 0 0 22px rgba(255, 45, 45, 0.32);
      z-index: 100;
    }

    .fingerBtn{
      width: 220px;
      height: 260px;
      background:
        radial-gradient(circle at 30% 18%, rgba(34,195,255,.22), rgba(255,255,255,1) 55%),
        linear-gradient(180deg, rgba(255,255,255,1), rgba(245,252,255,1));
      border-radius: 110px;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      touch-action: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .fingerBtn::before{
      content:"";
      position:absolute;
      inset: 12px;
      border-radius: 100px;
      border: 4px solid rgba(10,30,60,.06);
      background:
        radial-gradient(circle at 50% 45%, rgba(34,195,255,.16), rgba(255,255,255,0) 55%),
        repeating-radial-gradient(circle at 50% 55%,
          rgba(34,195,255,.16) 0 1px,
          rgba(255,255,255,0) 1px 8px);
      opacity: .95;
      z-index: 0;
      pointer-events:none;
    }

    .fingerBtn::after{
      content:"";
      position:absolute;
      inset: 10px;
      border-radius: 100px;
      border: 4px solid var(--blue);
      clip-path: inset(calc((1 - var(--p)) * 100%) 0 0 0);
      z-index: 3;
      pointer-events:none;
    }

    .fingerSvg{
      width: 96px;
      color: rgba(34,195,255,.95);
      opacity: 1;
      position: relative;
      z-index: 2;
      filter: drop-shadow(0 10px 18px rgba(34,195,255,.18));
    }

    .scanLine {
      position: absolute;
      width: 78%;
      height: 4px;
      background: var(--blue);
      box-shadow: 0 0 16px rgba(34,195,255,.9);
      border-radius: 2px;
      display: none;
      top: 20%;
      z-index: 4;
    }
    .scanning .scanLine { display: block; animation: scanAnim 1.55s infinite linear; }
    @keyframes scanAnim {
      0% { top: 22%; opacity: 0; }
      50% { opacity: 1; }
      100% { top: 78%; opacity: 0; }
    }

    @media (max-width: 480px){
      .app{
        padding: calc(12px + env(safe-area-inset-top)) 12px calc(14px + env(safe-area-inset-bottom));
      }

      header{ padding: 6px 0; }

      .title{
        font-size: clamp(22px, 6vw, 28px);
        padding: 10px 18px;
        border-radius: 18px;
      }

      .panel{
        margin-top: 14px;
        border-radius: 18px;
        padding: 14px;
      }

      #nameInput{
        height: 46px;
        font-size: 16px;
      }

      .scannerArea{
        min-height: 300px;
      }

      .arc{
        height: clamp(210px, 32vh, 260px);
      }

      .bubble{
        width: clamp(54px, 14vw, 70px);
        height: clamp(54px, 14vw, 70px);
        font-size: clamp(24px, 6vw, 32px);
      }

      .fingerBtn{
        width: clamp(180px, 62vw, 220px);
        height: clamp(220px, 74vw, 260px);
        border-radius: 999px;
      }

      .fingerSvg{
        width: clamp(84px, 22vw, 96px);
      }
    }
  </style>
</head>
<body>

  <div class="app">
    <header><div class="title">Allergy Test</div></header>

    <div class="panel" id="panel">
      <input type="text" id="nameInput" placeholder="Your name..." autocomplete="name" autocapitalize="words" />
      <div class="ageTrack" id="ageTrack"></div>
    </div>

    <div class="scannerArea" id="scannerArea">
      <div class="arc" id="arc"></div>

      <div class="fingerBtn" id="fingerBtn">
        <div class="scanLine"></div>

        <svg class="fingerSvg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M12 11.6c1.25 0 2.2 1.0 2.2 2.25 0 2.9-.95 5.75-2.1 7.45" />
          <path d="M8.8 11.9c0-2.35 1.75-4.4 4.1-4.4 2.65 0 4.8 2.05 4.8 5.15 0 4.55-1.55 7.5-2.75 8.9" />
          <path d="M6.9 12.2C6.9 8.9 9.35 5.4 12.4 5.4c3.95 0 6.7 2.55 6.7 7.2 0 3.25-.55 6.05-1.85 8.35" />
          <path d="M4.9 12.5c0-4.85 3.75-9.35 7.9-9.35 5.3 0 8.9 3.35 8.9 9.2" />
          <path d="M10.2 19.25c-.9-1.35-1.55-3.35-1.55-5.95" />
          <path d="M7.4 18.0c-1.2-1.75-2.0-3.95-2.0-6.2" />
        </svg>
      </div>
    </div>
  </div>

<script>
  const arc = document.getElementById('arc');
  const fingerBtn = document.getElementById('fingerBtn');
  const panel = document.getElementById('panel');
  const ageTrack = document.getElementById('ageTrack');
  const nameInput = document.getElementById('nameInput');

  const allergens = ["ðŸ¥œ","ðŸ“","ðŸ¥›","ðŸ¥š","ðŸ¤","ðŸ±","ðŸŒ¾","ðŸ«","ðŸŠ","ðŸŸ","ðŸ¯","ðŸ„","ðŸ…","ðŸ§€","ðŸ¥"];
  let bubbles = [];
  let scanning = false;

  /* ===== Close keyboard when name is finished =====
     Rule: pressing SPACE means name is finished.
     - We prevent inserting the space
     - We blur the input (keyboard closes)
     Also: on Enter (Done) we blur as well. */
  nameInput.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.code === 'Space') {
      e.preventDefault();
      nameInput.value = nameInput.value.trim();
      nameInput.blur();
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      nameInput.value = nameInput.value.trim();
      nameInput.blur();
    }
  });

  // If user types a trailing space (some keyboards), handle it too.
  nameInput.addEventListener('input', () => {
    // If last char is whitespace -> treat as finished
    if (/\s$/.test(nameInput.value)) {
      nameInput.value = nameInput.value.trim();
      nameInput.blur();
    }
  });

  // Optional: tap anywhere outside input to close keyboard
  document.addEventListener('pointerdown', (e) => {
    if (e.target !== nameInput && document.activeElement === nameInput) {
      nameInput.value = nameInput.value.trim();
      nameInput.blur();
    }
  });

  /* ===== Age scroller (center-highlight) ===== */
  const AGE_MIN = 15;
  const AGE_MAX = 25;
  const DEFAULT_AGE = 20;

  for(let i = AGE_MIN; i <= AGE_MAX; i++) {
    const div = document.createElement('div');
    div.className = 'ageItem' + (i === DEFAULT_AGE ? ' selected' : '');
    div.textContent = i;
    ageTrack.appendChild(div);

    div.addEventListener('click', () => {
      div.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    });
  }

  function getCenteredAgeItem() {
    const items = [...ageTrack.querySelectorAll('.ageItem')];
    const center = ageTrack.scrollLeft + ageTrack.clientWidth / 2;
    let best = null;
    let bestDist = Infinity;

    for(const el of items) {
      const elCenter = el.offsetLeft + el.offsetWidth / 2;
      const d = Math.abs(elCenter - center);
      if(d < bestDist) { bestDist = d; best = el; }
    }
    return best;
  }

  function updateAgeSelection() {
    const best = getCenteredAgeItem();
    if(!best) return;
    const items = ageTrack.querySelectorAll('.ageItem');
    items.forEach(el => el.classList.toggle('selected', el === best));
  }

  let rafPending = false;
  ageTrack.addEventListener('scroll', () => {
    if(rafPending) return;
    rafPending = true;
    requestAnimationFrame(() => {
      rafPending = false;
      updateAgeSelection();
    });
  }, {passive:true});

  window.addEventListener('load', () => {
    const items = [...ageTrack.querySelectorAll('.ageItem')];
    const def = items.find(el => Number(el.textContent) === DEFAULT_AGE) || items[0];
    if(def) def.scrollIntoView({behavior:'auto', inline:'center', block:'nearest'});
    updateAgeSelection();
  });

  /* ===== Bubbles ===== */
  function createBubbles() {
    arc.innerHTML = '';
    bubbles = [];
    const count = 5;
    for(let i=0; i<count; i++) {
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = allergens[Math.floor(Math.random()*allergens.length)];

      const angle = (i * (140 / (count - 1))) + 200;
      const x = 50 + Math.cos(angle * Math.PI / 180) * 40; // %
      const y = 55 + Math.sin(angle * Math.PI / 180) * 35; // %

      b.style.left = x + '%';
      b.style.top = y + '%';

      arc.appendChild(b);
      bubbles.push(b);
    }
  }
  createBubbles();

  function startScanning() {
    if(scanning) return;
    scanning = true;
    fingerBtn.classList.add('scanning');
    let p = 0;

    const interval = setInterval(() => {
      p += 0.01;
      fingerBtn.style.setProperty('--p', p);

      if(Math.random() > 0.7) {
        const b = bubbles[Math.floor(Math.random()*bubbles.length)];
        b.classList.add('replace');
        setTimeout(() => {
          b.textContent = allergens[Math.floor(Math.random()*allergens.length)];
          b.classList.remove('replace');
        }, 200);
      }

      if(p >= 1) {
        clearInterval(interval);
        showResults();
      }
    }, 30);
  }

  function showResults() {
    scanning = false;
    fingerBtn.classList.remove('scanning');
    fingerBtn.style.opacity = '0';
    panel.classList.add('hide');

    const chosen = bubbles.slice(0, 4);
    const rejected = bubbles[4];
    if(rejected) rejected.style.opacity = '0';

    setTimeout(() => {
      chosen.forEach(b => b.classList.add('result-active'));

      setTimeout(() => {
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2 + 40;

        const finalSize = Math.min(window.innerWidth * 0.35, 140);
        const gap = 20;

        const offsets = [
          { dx: -(finalSize/2 + gap/2), dy: -(finalSize/2 + gap/2) },
          { dx: (finalSize/2 + gap/2),  dy: -(finalSize/2 + gap/2) },
          { dx: -(finalSize/2 + gap/2), dy: (finalSize/2 + gap/2)  },
          { dx: (finalSize/2 + gap/2),  dy: (finalSize/2 + gap/2)  }
        ];

        chosen.forEach((b, i) => {
          const rect = b.getBoundingClientRect();
          b.style.left = (rect.left + rect.width/2) + 'px';
          b.style.top  = (rect.top  + rect.height/2) + 'px';
          b.style.position = 'fixed';
          b.style.margin = '0';

          b.classList.add('center-move');

          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              b.style.left = (centerX + offsets[i].dx) + 'px';
              b.style.top  = (centerY + offsets[i].dy) + 'px';
              b.style.width = finalSize + 'px';
              b.style.height = finalSize + 'px';
              b.style.fontSize = (finalSize * 0.6) + 'px';
            });
          });
        });

      }, 650);
    }, 650);
  }

  fingerBtn.addEventListener('pointerdown', startScanning);

  window.addEventListener('resize', () => {
    if(!scanning) createBubbles();
    updateAgeSelection();
  });
</script>

</body>
</html>
